{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "DeploymentID": {
            "type": "string",
            "minLength": 3,
            "maxLength": 6,
            "metadata": {
                "description": "Name prefix between 3-5 characters with only characters and numbers"
            }
        },
    },
    "variables": {
        "storageMLname": "[replace(replace(toLower(concat( variables('machinelearningName'), variables('uniqueName') )),'-',''),'_','')]",
        "keyvaultname": "[concat('kv', variables('uniqueName'))]",
        "appinsightsname": "[concat(variables('machinelearningName'), 'ai')]",
        "paramName": "[parameters('DeploymentID')]",
        "machinelearningName": "[concat('ml-', variables('paramName'))]",
        "computeInstanceName": "manymodel-compute",
        "disableLocalAuth": "false",
        "maxNodeCount": "1",
        "minNodeCount": "0",
        "nodeIdleTimeBeforeScaleDown": "PT120S",
        "remoteLoginPortPublicAccess": "NotSpecified",
        "vmSize": "Standard_DS3_v2",
        "vmPriority": "Dedicated",
        "datastoreName": "mldatastore",
        "containerName": "source",
        "storageAccountSubscriptionId": "[subscription().subscriptionId]",
        "storageAccountResourceGroup": "[resourceGroup().name]",
        "skipValidation": "false",
        "authenticationType": "Account Key",
        "storageName": "[replace(replace(toLower(concat( variables('paramName'), variables('uniqueName') )),'-',''),'_','')]",
        "relativePath": "transformed_data/ml_data_parquet/**",
        "datasetName": "mldataset",
        "location": "[resourceGroup().location]"
    },
    "resources": [
        {
            "type": "Microsoft.MachineLearningServices/workspaces/computes",
            "apiVersion": "2020-04-01",
            "name": "[concat(variables('machinelearningName'), '/', variables('computeInstanceName'))]",
            "location": "[variables('location')]",
             "dependsOn": [
              "[variables('machinelearningName')]",
              "[variables('storageMLname')]"
            ],
            "properties": {
              "computeType": "AmlCompute",
              "disableLocalAuth": "[variables('disableLocalAuth')]",
              "properties": {
                "remoteLoginPortPublicAccess": "[variables('remoteLoginPortPublicAccess')]",
                "scaleSettings": {
                  "maxNodeCount": "[variables('maxNodeCount')]",
                  "minNodeCount": "[variables('minNodeCount')]",
                  "nodeIdleTimeBeforeScaleDown": "[variables('nodeIdleTimeBeforeScaleDown')]"
                },
                "vmPriority": "[variables('vmPriority')]",
                "vmSize": "[variables('vmSize')]"
              }
            }
        },
        {
			"type": "Microsoft.MachineLearningServices/workspaces/datastores",
			"name": "[concat(variables('machinelearningName'), '/', variables('datastoreName'))]",
			"apiVersion": "2020-05-01-preview",
			"location":  "[variables('location')]",
			"dependsOn": [
				"[variables('machinelearningName')]",
				"[variables('storageName')]"
			],
			"properties": {
				"DataStoreType": "blob",
				"AccountName": "[variables('storageName')]",
				"ContainerName": "[variables('containerName')]",
				"AccountKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageName')), '2019-06-01').keys[0].value]"
			}
		},
        {
            "type": "Microsoft.MachineLearningServices/workspaces/datasets",
            "name": "[concat(variables('machinelearningName'), '/', variables('datasetName'))]",
            "apiVersion": "2020-05-01-preview",
            "location": "[variables('location')]",
             "dependsOn": [
                  "[variables('machinelearningName')]",
                  "[resourceId('Microsoft.MachineLearningServices/workspaces/datastores', variables('machinelearningName'), variables('datastoreName'))]"		
                      ],
            "properties": {
              "SkipValidation": "[variables('skipValidation')]",
              "DatasetType": "Tabular",
              "variables": {
                "Path": {
                  "DataPath": {
                    "RelativePath": "[variables('relativePath')]",
                    "DatastoreName": "[variables('datastoreName')]"
                  }
                }
              }
            }
        },
        { 
            "apiVersion": "2020-10-01",
            "name": "pid-fcd51158-1534-584d-a653-5a46bbe4ad99",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        }
    ]
}
